<template>
    <div i="wechat-material-edit">
        <div class="edit-body">
            <div class="pull-left preview">
                <div class="outer">
                    <div class="inner" :style="{backgroundImage: 'url('+ img_cover +')'}">
                        <span class="title">{{form.title}}</span>
                    </div>
                </div>
            </div>
            <div class="pull-left js-editor-area">
                <div class="js-editor">
                    <!-- <vue-editor v-model="content"></vue-editor>
                    <a class="unfold" v-if="is_unfold" @click="unfoldContent"><i class="icon ion-ios-plus"></i>展开正文</a> -->
                    <div class="title mb20">                      
                        <input id="title" type="text" 
                            v-model.trim="form.title"
                            @blur="form.title = form.title.length > 64 ? form.title.substring(0, 64) : form.title" 
                            placeholder="请在这里输入标题" 
                            class="js-title" name="title" max-length="64">
                        <span :class="{danger: form.title.length > 64}">{{form.title.length}}/64</span>
                    </div>
                    <div class="author mb20">
                        <input id="author" type="text" 
                            v-model.trim="form.author"
                            @blur="form.author = form.author.length > 8 ? form.author.substring(0, 8) : form.author"
                            placeholder="请在这里输入作者" class="js-author" name="author" max-length="8">
                        <span :class="{danger: form.author.length > 8}">{{form.author.length}}/8</span>
                    </div>  
                    <div style="padding-left: 60px;">
                        <el-checkbox v-model="is_link" @change="setLink">设为链接图文</el-checkbox>
                    </div>  

                    <!-- <div class="edit-extra" style="border-bottom: none;padding-bottom: 20px;">
                        <el-checkbox v-model="link_checked">原文链接</el-checkbox>
                        <div class="mt10 ml20" v-show="link_checked">
                            <el-input v-model.trim="form.url"></el-input>
                        </div>
                    </div>  -->               
                    <div class="js-ueditor" v-show="!is_link">
                        <textarea i="material_content" type="text/plain" style="width:100%;height:100%;"></textarea>
                    </div>
                </div>
                <div class="edit-extra">
                    <el-checkbox v-model="link_checked" :disabled="is_link">原文链接</el-checkbox>
                    <div class="mt10 ml20" v-show="link_checked">
                        <el-input v-model.trim="form.url"></el-input>
                    </div>
                </div>
                <div class="edit-extra">
                    <p class="title">发布样式编辑</p>
                    <div class="desc">
                        <span class="title">封面</span>
                        <span class="tips">大图片建议尺寸：900像素 * 500像素</span>
                    </div>
                    <div class="mt10">
                        <!-- <el-button @click="dlgCoverVisible = true">从正文选</el-button>
                        <el-button>从图片库选</el-button> -->
                        <div v-show="img_cover != ''" class="cover" :style="{backgroundImage: 'url('+ img_cover+')'}">
                            <div class="cover-del" @click="clearCover"><i class="icon ion-ios-trash"></i></div>
                        </div>
                        <div id="cover_container" class="cover-add" v-show="img_cover == ''">
                            <span id="upload_progress"></span>
                            <a id="cover_picker">
                                <i class="icon ion-ios-plus-empty"></i>
                            </a>                            
                        </div>
                    </div>
                    <!-- <div class="warning" v-show="img_cover == ''">必须插入一张图片</div> -->
                    <div class="desc">
                        <span class="title">摘要</span>
                        <span class="tips">选填，如果不填写会默认抓取正文前54个字</span>
                    </div>
                    <textarea v-model="form.desc"
                        @blur="form.desc = form.desc.length > 120 ? form.desc.substring(0, 120) : form.desc"></textarea>
                    <div class="desc-count text-right" :class="{danger: form.desc.length > 120}">{{form.desc.length}}/120</div>
                </div>
            </div>
            <!-- <div class="pull-left media-draft">
                <p class="title">多媒体</p>
                <div class="media-outer">
                    <a class="" @click="inputPhoto"><i class="img"></i>图片</a>
                    <a class=""><i class="video"></i>视频</a>
                    <a class=""><i class="voice"></i>音频</a>
                </div>
            </div>   -->
            <div class="clearfix"></div>          
        </div>
        <div class="bottom-fixed">
            <div class="bottom-center">
                <!-- <a class="unfold" v-if="!is_unfold" @click="unfoldContent"><i class="icon ion-ios-plus"></i>收起正文</a>
                <a class="unfold" v-else @click="unfoldContent"><i class="icon ion-ios-plus"></i>展开正文</a> -->
                <div class="">
                    <el-button class="btn-green" @click="save">保存</el-button>
                    <!-- <el-button>预览</el-button>
                    <el-button>保存并群发</el-button> -->
                </div>
                
            </div>
        </div>
        <photo-select-dialog 
            @closeDlg="closeDlg"
            :title="photo_title"
            :dialogVisible="showPhotoDlg">                
            </photo-select-dialog>
        <el-dialog
        title="选择封面"
        custom-class="cover-select-dlg"
        :close-on-click-modal="false"
        :close-on-press-escape="false"
        :before-close="closeCoverDlg"
        :visible.sync="dlgCoverVisible">
        <div class="dlg-body">
            <template v-if="img_data.length > 0">
                <div class="desc">
                    请从正文使用过的图片中选择封面
                    <span>尺寸小于200*200的图片已被自动过滤</span>
                </div>
                <div class="photo-list">
                    <a class="item" v-for="(img, i) in img_data" @click="checkCoverImg(i)">
                        <span class="bg-img" :style="{backgroundImage : 'url('+ img.url +')'}"></span>
                        <span class="bg-checked" v-if="img.is_checked">
                            <i class="icon ion-checkmark"></i>
                        </span>
                        <span class="bg-checked-hover" v-else>
                            <i class="icon ion-checkmark"></i>
                        </span>
                    </a>
                </div>                            
            </template>
            <div class="pic-empty" v-else>
                <i class="warning pull-left mr10"></i>
                <p>正文中无可用做封面的图片</p>
                <p>封面图片必须为正文中使用过的图片，图片尺寸需大于200*200px，请在正文中插入图文后再选择封面图片</p>
            </div>
        </div>
        <div slot="footer" class="dialog-footer text-center">
            <el-button class="mr30" @click="subCoverImg" :disabled="!has_cover_checked">确 定</el-button>
        </div>
    </el-dialog>
    </div>
</template>
<style rel="stylesheet/scss" lang="scss">
    @import "../../../assets/tool";
    @import "../../../assets/sass/common/wechat_btn";

    [i="wechat-material-edit"]{
        position: relative;
        .edit-body{
            padding-bottom: 100px;
            .preview{
                min-height:200px;
                width: 250px;
                .outer{
                    width: 210px;
                    height: 142px;
                    padding: 9px 9px;
                    border: 2px solid #43b548;
                    .inner{
                        width: 188px;
                        height: 120px;
                        position: relative;
                        background:#ececec no-repeat center center/cover;
                        .title{
                            font-size: 14px;
                            height: 28px;
                            width: 100%;
                            position: absolute;
                            bottom: 0;
                            background: rgba(0,0,0,0.6)!important;
                            padding: 0 8px;
                            line-height: 28px;
                            color: #fff;
                        }
                    }
                }
            }
            @media screen and (max-width: 1380px) {
                .preview{
                    margin-left: 60px;
                }
            }
        }
        .js-editor-area{
            width: 780px;
            .js-editor{
                position: relative;
                .unfold{
                    display: block;
                    width: 100px;
                    height: 25px;
                    margin: 0 auto;
                    color: #ccc;
                    i{
                        padding-right: 5px;
                        font-size: 18px;
                    }
                }
                .quillWrapper{
                    .ql-toolbar.ql-snow{
                        border-right: none;
                    }
                    .ql-container{
                        margin-top: 130px;
                        width: 650px;
                        margin-left: 60px;
                        border: none;
                        border-top: 1px solid #ccc;
                        padding-top: 30px;
                        &.fold{
                            height: 90px!important;
                            overflow: hidden!important;

                            .ql-editor{
                                overflow: hidden!important;
                            }
                        }
                        .ql-editor{
                            padding: 0;
                        }
                    }
                }
                .title{
                    /* position: absolute; */
                    width: 100%;
                    top: 60px;
                    padding-left: 60px;
                    .js-title{
                        font-size: 22px;
                        height: 46px;
                        line-height: 46px;
                        border: none;
                        outline: 0;
                        width: 90%;
                    }
                    span{
                        &.danger{
                            color: #e15f63;
                        }
                        display: inline-block;
                        text-align: right;
                    }
                }
                .author{
                    /* position: absolute; */
                    width: 100%;
                    top: 120px;
                    padding-left: 60px;
                    .js-author{
                        font-size: 14px;
                        height: 22px;
                        margin: 4px 0;
                        border: none;
                        outline: 0;
                        width: 90%;
                    }
                    span{
                        &.danger{
                            color: #e15f63;
                        }
                        display: inline-block;
                        text-align: right;
                    }
                }
                .js-ueditor{
                    padding: 20px 40px 0 60px;

                }
            }
            .edit-extra{
                padding: 20px;
                padding-left: 60px;
                padding-bottom: 40px;
                padding-right: 55px;
                border-bottom: 1px solid #ccc;
                .title{
                    color: #222;
                }
                p.title{
                    padding: 15px 0;
                }
                .tips{
                    color: #8d8d8d;
                }
                .desc{
                    line-height: 35px;
                    height: 35px;    
                    margin-top: 15px;
                }
                .desc-count{
                    &.danger{
                        color: #e15f63;
                    }
                    
                }
                .cover{
                    width: 188px;    
                    height: 188px;
                    background-repeat: no-repeat;
                    background-position: center center;
                    background-size: cover;
                    position: relative;
                    .cover-del{
                        width: 100%;
                        height: 100%;
                        position: absolute;
                        display: none;  
                        line-height: 188px;
                        text-align: center;
                        color: #fff;
                        font-size: 64px;
                        cursor: pointer;
                    }
                    &:hover .cover-del{
                        display: block;
                        background-color: rgba(0, 0, 0, .5);
                    }
                }
                .cover-add{
                    color: #e7e7eb;
                    width: 188px;    
                    height: 188px;  
                    line-height: 188px;
                    border: 3px dotted #e7e7eb;
                    display: block;
                    text-align: center;
                    a{
                        display: block;
                        width: 100%;
                        height: 100%;
                        color: #e7e7eb;
                        i{
                            font-size: 64px;
                            display: block;
                        }
                    }

                }
                .warning{
                    color: #e15f63;
                    line-height: 35px;
                    height: 35px;
                }
                textarea{
                    outline: 0;
                    border: 1px solid #ccc;
                    resize: none;
                    width: 100%;
                    height: 100px;
                    padding: 10px;
                }
                &:last-child{
                    border-bottom: none;
                    padding-bottom: 0;
                }

            }

        }
        .media-draft{
            width: 215px;
            padding: 20px;
            padding-top: 0;
            position: absolute;
            left: 780px;
            top: 0;
            bottom: 0;
            border: 1px solid #ccc;
            .title{
                height: 50px;
                line-height: 50px;
            }
            .media-outer{
                border: 1px solid #ccc;
                border-bottom: none;
                a{
                    padding-top: 6px;
                    padding-left: 20px;
                    display: block;
                    height: 50px;
                    line-height: 40px;
                    color: #8d8d8d;
                    border: 1px solid transparent;
                    border-bottom: 1px solid #ccc;
                    i{
                        vertical-align: top;
                        background-image: url(../../../assets/msg_tab.png);
                        display: inline-block;
                        margin-right: 10px;
                        width: 20px;
                        height: 30px;
                        &.appmsg{
                            background-position-y: 179px;
                        }
                        &.img{
                            background-position-y: 359px;
                        }
                        &.voice{
                            background-position-y: 238px;
                        }
                        &.video{
                            background-position-y: 299px;
                        }
                    }
                    &:hover{
                        color: #222;
                    }
                    &:hover i{
                        &.appmsg{
                            background-position-y: 149px;
                        }
                        &.img{
                            width: 20px;
                            height: 30px;
                            background-position-y: 329px;
                        }
                        &.voice{
                            width: 20px;
                            height: 30px;
                            background-position-y: 208px;
                        }
                        &.video{
                            width: 20px;
                            height: 30px;
                            background-position-y: 269px;
                        }
                    }
                }
            }
        }
        .bottom-fixed{
            width: 100%;
            height: 72px;
            line-height: 72px;
            position: absolute;
            bottom: 0;
            background-color: #fff;
            border-top: 1px solid #ccc;
            .bottom-center{
                /* width: 780px; */
                margin-left: 310px;
                .unfold{
                    color: #222;
                    i{
                        color: #ccc;
                        padding-right: 5px;
                        font-size: 18px;
                    }
                }

            }
        }

        .cover-select-dlg{
            &.el-dialog{
                width: 726px!important;
                height: 559px!important;
            }
            .el-dialog__header{
                border-bottom: 1px solid #e7e7eb;
                height: 52px;
                background-color: rgb(244, 245, 249);
                .el-dialog__title{
                    font-weight: normal;
                }
            }
            .el-dialog__body{
                padding: 0;
            }
            .el-dialog__footer{
                padding: 0;
                border-top: 1px solid #e7e7eb;
                text-align: left;
            }

            .dlg-body{
                height: 441px;
                padding: 30px 0 0 45px;
                .pic-empty{     
                    width: 500px;
                    margin-left: 65px;
                    margin-top: 130px;
                    .warning{
                        display: inline-block;
                        width: 55px;
                        height: 55px;
                        background: url(../../../assets/warning.png) no-repeat center center/contain;
                    }
                }
                .desc{
                    span{
                        color: #8d8d8d;
                    }
                }
                .photo-list{
                    padding: 20px 20px 5px 0;
                    height: 340px;
                    overflow: hidden;
                    .item{
                        display: inline-block;
                        position: relative;
                        margin-right: 11px;
                        margin-bottom: 10px;
                        span{
                            display: block;
                        }
                        .bg-img{
                            width: 117px;
                            height: 117px;
                            background-size: cover;
                        }
                        .title{
                            height: 32px;
                            line-height: 32px;
                            @include wordEllipsis();
                            color: #222;
                            padding: 0 10px;
                            max-width: 115px;
                        }
                        .bg-checked{
                            position: absolute;
                            width: 117px;
                            height: 117px;
                            background-color: rgba(0,0,0,.5);
                            color: #fff;
                            line-height: 117px;
                            text-align: center;
                            top: 0;
                            left: 0;
                            i{
                                font-size: 64px;
                            }
                        }
                        .bg-checked-hover{
                            display: none;
                            position: absolute;
                            width: 117px;
                            height: 117px;
                            background-color: rgba(0,0,0,.5);
                            color: #fff;
                            line-height: 117px;
                            text-align: center;
                            top: 0;
                            left: 0;
                            i{
                                font-size: 64px;
                            }

                        }
                        &:hover .bg-checked-hover{
                            display: block;
                        }

                    }
                }

            }
            .dialog-footer{
                padding: 0;
                line-height: 65px;
                background-color: #f4f5f9;
            }
        }

    }
</style>
<script>
    import '../../../../static/ueditor/ueditor.config.js';
    import '../../../../static/ueditor/ueditor.all.js';
    import {Verify,Upload} from 'hanzi-vue-package';
    tools.vue.use(Upload);
    import photoSelectDialog from '../../../components/wechat/Photoselectdialog';
    import {Button,Checkbox,Input} from 'element-ui';
    tools.vue.use(Button);
    tools.vue.use(Checkbox);
    tools.vue.use(Input);
    
    export default{
        data(){
            this.crumbs.push({name:'微信管理'},{name:'素材管理',url:'/wechat/material/material'});
            return {
                content: '<h1>Some initial content</h1>',
                customToolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    
                  ],/*['image']*/
                id: tools.url.params('id'),
                link_checked: false,
                is_link: false,
                is_unfold: false,//true为展开状态
                img_cover: '',//'/static/img/hanzi_logo_2.84dfb7c.png',
                form:{
                    title: '',//标题
                    author: '',//作者
                    desc: '',//摘要,
                    content: '',
                    cover_id: 0,
                    url: '',
                    type: 1,
                },
                photo_title: '选择图片',
                showPhotoDlg: false,
                dlgCoverVisible: false,                
                img_data: [
                    /*{
                        name: '已开启图片水印启图片水印',
                        url: '/static/img/hanzi_logo_2.84dfb7c.png',
                        is_checked: false
                    }*/
                ],
                has_cover_checked: false
            }
        },
        props: ['crumbs'],
        computed:{

        },
        methods: {
            inputPhoto: function(){
                let that = this;
                that.showPhotoDlg = true;

            },
            closeDlg: function(img_data){
                let that = this;
                that.showPhotoDlg = false;
                if(img_data){
                    console.log(img_data);
                }

            },
            checkCoverImg: function(idx){
                let that = this;
                that.has_cover_checked = false;
                if(that.img_data[idx].is_checked){
                    that.img_data[idx].is_checked = !that.img_data[idx].is_checked;
                }
                else{
                    for(let i in that.img_data){
                        that.img_data[i].is_checked = false;
                    }
                    that.img_data[idx].is_checked = true;
                    that.has_cover_checked = true;
                }
            },
            closeCoverDlg: function(){
                let that = this;
                //that.img_data = [];
                that.has_checked = false;
                that.dlgCoverVisible = false;


            },
            subCoverImg: function(){

            },
            unfoldContent() {
                let that = this;
                if(that.is_unfold){
                    $('.ql-container').removeClass('fold');
                }
                else{
                    $('.ql-container').addClass('fold');
                }
                that.is_unfold = !that.is_unfold;
            },
            setLink: function(){
                let that = this;
                that.link_checked = that.is_link;
            },
            getData: function(){
                let that = this;                
                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/newses/'+ that.id,
                    ajaxData: {},
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        if(res && res.status){
                            that.form.title = res.data.title;
                            that.form.desc = res.data.desc;
                            that.form.author = res.data.author;
                            that.img_cover = res.data.cover;
                            that.form.type = res.data.type;
                            that.form.url = res.data.url;
                            if(res.data.content){
                                that.form.content = res.data.content;
                                UE.getEditor('container'+that.num).setContent(that.form.content);
                            }
                            if(res.data.type === 2){
                                that.link_checked = true;
                                that.is_link = true;
                            }
                        }

                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'GET'
                });

            },
            clearCover: function(){
                let that = this;
                that.img_cover = '';
                that.form.cover_id = 0;
            },
            save: function(){
                var that = this,
                        ajaxData = {};

                that.form.content = UE.getEditor('container'+ that.num).getContent();

                var verify = Verify.run([
                    {
                        type : 'notEmpty',
                        value : that.form.title,
                        name : '文章标题',
                        canEmpty : false
                    }
                ]);

                if(verify !== true){
                    tools.alert.error(verify.msg);
                    return;
                }
                ajaxData.title = that.form.title;
                if(that.form.cover_id > 0){
                    ajaxData.cover_id = that.form.cover_id;
                }
                else{
                    if(!that.id){
                        tools.alert.error('请上传封面');
                        return;
                    }
                }
                if(that.form.desc){
                    ajaxData.desc = that.form.desc;
                }
                if(that.form.author){
                    ajaxData.author = that.form.author;
                }
                ajaxData.type = that.form.type = 1;
                if(that.link_checked){
                    ajaxData.type = that.form.type = 2;
                    ajaxData.url = that.form.url;
                    if(!/^((ht|f)tps?):\/\/[\w\-]+(\.[\w\-]+)+([\w\-\.,@?^=%&:\/~\+#]*[\w\-\@?^=%&\/~\+#])?$/.test(ajaxData.url)){
                        tools.alert.message('链接格式错误');
                        return false;
                    }
                }
                else{
                    if(that.form.content){
                        ajaxData.content = that.form.content;
                    }
                    else{
                        tools.alert.error('请填写内容');
                        return;
                    }

                }
                tools.alert.loading();
                if(that.id){
                    tools.ajax({
                        url: '/api/admin/wechat/newses/'+ that.id,
                        ajaxData: ajaxData,
                        successFun: function (res) {
                            tools.alert.closeLoading();
                            if(res && res.status){
                                tools.alert.message('修改成功');
                                that.form.cover_id = 0;
                            }

                        },
                        errorFun: function (error_data, status, headers, error_obj) {
                            tools.alert.closeLoading();
                            tools.alert.error(error_data.error_msg);
                        },
                        type: 'PUT'
                    });

                }
                else{
                    tools.ajax({
                        url: '/api/admin/wechat/newses',
                        ajaxData: ajaxData,
                        successFun: function (res) {
                            tools.alert.closeLoading();
                            if(res && res.status){
                                tools.alert.message('添加成功');
                                that.form.cover_id = 0;
                                that.toUrl('./material');
                            }

                        },
                        errorFun: function (error_data, status, headers, error_obj) {
                            tools.alert.closeLoading();
                            tools.alert.error(error_data.error_msg);
                        },
                        type: 'POST'
                    });

                }
            },
            //初始化百度编辑器
            ueditor : function () {
                var that = this;
                that.num =  new Date().getTime();

                $('[i="material_content"]').attr('id','container'+ that.num);

                that.editor = UE.getEditor('container'+ that.num, {
                    initialFrameHeight: 250,
                    serverUrl: window.config.api.url + '/api/admin/editor?token='+tools.cache.get('Authorization')
                });

            },
            /*clearData: function(){
                let that = this;
                that.link_checked = false;
            },*/
            /* 连接变化时执行 */
            isLinkChange: function () {
                let that = this;
                that.id = tools.url.params('id');
                that.crumbs.push({name:'微信管理'},{name:'素材管理',url:'/wechat/material/material'});
                /*that.clearData();
                that.getData();*/
            },
            //计算字数, 1个汉字等于2个字符
            charCount: function(d, size){
                let that = this;
                let count = that.dataLength(d);
                let tmpData = '';
                if(count > size){
                    var intLength = 0;
                    for(var i = 0; i < d.length; i++) { 
                        if ((d.charCodeAt(i) < 0) || (d.charCodeAt(i) > 255)) {
                            intLength=intLength+2                                 
                        }
                        else {
                            intLength=intLength+1    
                        }
                        if(intLength <= size){
                            tmpData += d[i];
                        }
                        else{
                            break;
                        }
                    } 
                }
                else{
                    return d;
                }
                return tmpData;
            },
            //* 出口参数：返回fData的长度(Unicode长度为2，非Unicode长度为1) 
            dataLength: function (fData) { 
                var intLength=0 
                for (var i=0;i<fData.length;i++) 
                { 
                    if ((fData.charCodeAt(i) < 0) || (fData.charCodeAt(i) > 255)) 
                        intLength=intLength+2 
                    else 
                        intLength=intLength+1    
                } 
                return intLength 
            },
            /* 跳转 */
            toUrl: function (url, val) {
                tools.router.push({path: url, query: val});
            }

        },
        components: {
            photoSelectDialog
        },
        filters:{

        },
        watch:{
            // 如果路由有变化，会再次执行该方法
            '$route': 'isLinkChange'

        },
        mounted(){
            let that = this, crumbsName = '新建图文消息';
            if(tools.url.params('id')){
                crumbsName = '编辑图文消息';
            }
            that.crumbs.push({name: crumbsName});

            var uploads = new upload({
                container: 'cover_container',     //容器ID
                browse_button: 'cover_picker', //按钮ID
                progress:'upload_progress',        //进度条ID
                type: 'wechat_news',      //请求接口时的传参，upload_type:"headpic"
                setting : 'local',          //local：本地，cloud：云
                chunk_size : '200kb',       //分段传输的大小
                group: ['img'],             //上传格式组
                url: '/api/admin/upload',
                callback: function (res) {
                  that.img_cover = res.data.url;
                  that.form.cover_id = res.data.upload_id;
                }
            });
            that.ueditor();
            if(that.id){
                that.getData();
            }
            /*$('.ql-editor').click(function(){
                that.is_unfold = true;
                that.unfoldContent();
            });*/
        }
    }
</script>
