<template>
    <div i="wechat-setting">
        <div class="tips" style="display: none;">
            <p>提示：要使用自定义菜单，需要公众号平台申请自定义菜单的“Appid”和“AppSecret”，然后填入下面的表单</p>
            <!-- <p>1、要使用自定义菜单，需要公众号平台申请自定义菜单的“Appid”和“AppSecret”，然后填入下面的表单；</p>
            <p>2、提交完“Appid”和AppSecret“后，设置菜单，然后点击”保存“按钮，自定义菜单功能便能生效了；</p>
            <p>3、微信公众号自定义菜单最多创建3个一级菜单，最多输入4和汉字，每个一级菜单下最多可以创建5个二级菜单，最多输入7个汉字；</p>
            <p>4、微信公众平台规定：菜单发布24小时后生效。如果为新增粉丝，则可马上看到菜单；</p>
            <p>5、同步：菜单内容编辑完成后，需要点击按钮“同步”才能将编辑的信息显示到微信手机端。</p> -->
        </div>
        <div>
            <div class="layui-form-item">
                <label class="layui-form-label">APPID</label>
                <div class="layui-input-inline">
                    <input type="text" v-model.trim="appid" placeholder="请输入APPID" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">APPSECRET</label>
                <div class="layui-input-inline">
                    <input type="text" v-model.trim="appsecret" placeholder="请输入APPSECRET" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">加密串</label>
                <div class="layui-input-inline">
                    <input type="text" v-model.trim="encodingaeskey" placeholder="请输入加密串" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">TOKEN</label>
                <div class="layui-input-inline">
                    <input type="text" v-model.trim="token" disabled class="layui-input">
                </div>
                <button class="change_token" @click="getToken">更改</button>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">对接接口</label>
                <!-- <div class="layui-input-inline">
                    <input type="text" v-model.trim="url" disabled class="layui-input">
                </div> -->
                <div class="layui-form-mid layui-word-aux f14">{{url}}</div>
            </div>
             <div class="layui-form-item">
                <label class="layui-form-label">公众号二维码</label>
                <div class="ml30">
                    <div class="prelook-wrapper clearfix pb10" id="container2">
                        <div class="prelook-inner" v-show=" img!=''">
                            <span class="circle-box" @click="img='';img_id=0;">
                                <i class="circle"></i>
                            </span>
                            <a rel="group" class="fancybox prelook-block">
                                <img :src="img">
                            </a>
                        </div>
                        <div class="form-groups" v-show="img==''">
                            <div class="col-10">
                                <div class="upload-wrapper" id="pickfiles2" style="margin-top:0;">
                                    <div class="progress text-center" id="progress2"></div>
                                    <i class="fa fa-plus f16"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>              
            </div>
            <div class="layui-block pt10">
                <el-button class="btn-green ml100" @click="save">保存</el-button>
            </div>
        </div>
    </div>
</template>
<script>
    import {Verify,baseUpload,Compare} from 'hanzi-vue-package';
    import {Input,Button,Tabs,TabPane} from 'element-ui';
    tools.vue.use(baseUpload);
    tools.vue.use(Input);
    tools.vue.use(Button);
    tools.vue.use(Tabs);
    tools.vue.use(TabPane);
    
    export default{
        data(){
            this.crumbs.push({name:'微信管理'},{name:'微信设置'});
            return {
                appid: '',
                appsecret: '',
                token: '',
                url: '',
                img: '',
                img_id: 0,
                encodingaeskey: ''
            }
        },
        props: ['crumbs'],
        computed:{

        },
        methods: {
            getData: function(){
                let that = this;

                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/configs/mp',
                    ajaxData: {},
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        that.appid = res.data.appid;
                        that.appsecret = res.data.appsecret;
                        that.token = res.data.token;
                        that.url = res.data.url;
                        that.img = res.data.qrcode;
                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'GET'
                });
            },
            save: function() {
                let that = this, ajaxData = {};

                if(that.appid == ''){
                    tools.alert.message('请输入APPID');
                    return false;
                }
                if(that.appsecret == ''){
                    tools.alert.message('请输入APPSECRET');
                    return false;
                }
                ajaxData.appid = that.appid;
                if(that.img_id==0){
                    ajaxData.img_id = '';
                }else{
                    ajaxData.img_id = that.img_id;
                }
                ajaxData.appsecret = that.appsecret;
                ajaxData.token = 1;
                if(that.encodingaeskey != ''){
                    ajaxData.encodingaeskey = that.encodingaeskey;
                }

                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/configs/mp',
                    ajaxData: ajaxData,
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        if(res && res.status){
                            tools.alert.message('保存成功');
                        }
                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'PUT'
                });
            },
            getToken: function(){
                let that = this, ajaxData = { token: 1 };

                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/configs/mp',
                    ajaxData: ajaxData,
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        if(res && res.status){
                            that.getData();
                        }
                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'PUT'
                });

            },
            /* 跳转 */
            toUrl: function (url, val) {
                tools.router.push({path: url, query: val});
            }

        },
        components: {
        },
        filters:{

        },
        watch:{

        },
        mounted(){
            let that = this
            var uploads2 = new upload({
                container: 'container2',     //容器ID
                browse_button: 'pickfiles2', //按钮ID
                progress:'progress2',        //进度条ID
                type: 'wechatmp_img',      //请求接口时的传参，upload_type
                setting : 'local',          //local：本地，cloud：云
                chunk_size : '200kb',       //分段传输的大小
                group: ['img'],
                url: '/api/admin/upload',   //上传路径
                callback: function (res) {
                    
                    that.img_id=res.data.upload_id
                    that.img=res.data.url
                     /*res.data.is_default = 0;
                     res.data.id = 0;
                     that.imgs.push(res.data);*/
                }
            });
            this.getData();
        }
    }
</script>
<style rel="stylesheet/scss" lang="scss">
    @import "../../assets/tool";
    @import "../../assets/sass/common/wechat_btn";
    [i="wechat-setting"]{
        .tips{
            background-color: #f1f2f7;
            padding: 25px;
            margin-bottom: 15px;            
        }
        .app-input {
            width: 50%!important;
            min-width: 500px!important;
            display: table!important;
            margin-bottom: 15px;
        } 
        .layui-form-item .layui-input-inline{
            min-width: 500px!important;
                line-height: 20px;
        }
        .change_token{
            padding: 9px 15px;
            color: #2f9833;
            &:hover{
                color: #13ce66;
            }
        }
        .el-button{
            width: 140px;
            height: 40px;
            &:hover{
                color: #fff;
                background-color: rgba(107, 107, 107, 1);
                border-color: rgba(107, 107, 107, 1);
            }
        }       
    }
    .prelook-wrapper{
        padding-top: 10px;
        //border-bottom: 1px dotted #ddd;
    }
    .prelook-wrapper .upload-wrapper{
        float: left;
        position: relative;
        width: 120px;
        height: 120px;
        text-align: center;
        line-height: 120px;
        border: 1px solid #ddd;
        margin-bottom: 20px;
        cursor: pointer;
        overflow: hidden;
    }
    .prelook-wrapper .upload-wrapper i{
        line-height: 120px;
    }
    .prelook-wrapper .prelook-inner .circle-box{
        position: absolute;
        right: -10px;
        top: -10px;
        cursor: pointer;
        z-index: 1;
    }
    .prelook-wrapper .prelook-inner .circle{
        @include round_close(22px);
    }
    .prelook-wrapper .upload-wrapper .file-button{
        font-size: 200px;
        opacity: 0;
        position: absolute;
        left: 0;
        top: 0;
        width: 120px;
        height: 120px;
        cursor: pointer;
        z-index: 9;
    }
    .prelook-inner {
        float: left;
        width: 120px;
        /*height: 160px;*/
        margin-right: 20px;
        margin-bottom: 10px;
        position: relative;
    }
    .prelook-inner i.fa-times-circle {
        font-size: 20px;
        position: absolute;
        top: -10px;
        right: -10px;
        z-index: 999;
        cursor: pointer;
    }
    .prelook-block {
        display: block;
        width: 120px;
        height: 120px;
        overflow: hidden;
        position: relative;
    }
    .prelook-block img {
        width: 100%;
    }
    .prelook-inner .prelook-radio {
        display: block;
        width: 100%;
        height: 30px;
        line-height: 30px;
        padding-left: 10px;
        
    } 
    .prelook-inner .prelook-radio .radio{
        display: inline-block;
        @include radio_core(#5FB878,16px); //#5FB878,#1e9fff
    }
</style>
