<template>
    <div i="app-msg">
        <div class="div-search">
            <el-input
              placeholder="标题"
              v-model.trim="inputTxt">
            </el-input>    
            <el-date-picker
                v-model="timerange"
                type="daterange"
                placeholder="选择日期范围">
            </el-date-picker> 

            <!-- <el-popover
                ref="popover"
                placement="bottom"
                width="290"
                v-model="isShow"
                trigger="click">
                <div class="slot-txt">
                    <p>删除后不会影响已群发的图文消息，确定删除该素材吗？</p>
                    <p>
                        <el-button @click="isShow = false">取消</el-button>
                    </p>
                </div>
                <el-button class="btn-green" slot="reference">搜索</el-button> 
            </el-popover> -->  
            <el-button class="btn-green" @click="search">搜索</el-button>  
        </div>
        <div class="div-opt mt20 pb10 pr20">
            <div class="pull-left mr20">图文搜索(共{{page.total}}条)</div>
            <div class="pull-left">
            <i class="i-rank pull-left grid-rank icon ion-ios-grid-view" :class="{active: is_grid}" @click="is_grid = 1" title="表格形式"></i>
            <i class="i-rank pull-left list-rank icon ion-ios-list-outline" :class="{active: !is_grid}" @click="is_grid = 0" title="列表形式"></i>
            </div>
            <div class="pull-right">
                <el-button class="btn-create btn-green" @click="toUrl('/wechat/material/edit')">新建图文素材</el-button>
                <!-- <el-dropdown class="btn-create-share" trigger="click">
                    <span class="el-dropdown-link classify-title" style="color: #9B9B9B;">
                    <i class="el-icon-arrow-down el-icon--right f12 ml10"></i>
                    </span>
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item command="0">新建分享图文</el-dropdown-item>
                    </el-dropdown-menu>
                </el-dropdown> -->
            </div>
        </div>
        <div class="div-grid-view" v-if="is_grid">
            <div class="grid-item" v-for="(item, i) in lists">
                <p class="time">
                    更新于 {{item.updated_at | date}}
                    <span class="type pull-right">{{item.type == 1 ? '图文素材' : '图文链接'}}</span>
                </p>
                <div class="body">
                    <div class="content">
                        <span>{{item.title}}</span>
                        <div class="bg" :style="{backgroundImage: 'url('+ item.cover +')'}"></div>
                        <span>{{item.desc}}</span>
                    </div>
                    <div class="hover" @click="toUrl('/wechat/material/preview',{id: item.id})">预览文章</div>
                </div>
                <div class="opr">
                    <el-tooltip class="item" effect="dark" content="编辑" placement="top">
                        <i class="create icon ion-android-create" @click="toUrl('/wechat/material/edit',{id: item.id})"></i>                
                    </el-tooltip>
                    <template v-if="arrShow.length > 0">
                        <el-tooltip class="item" effect="dark" content="删除" placement="top">
                            <el-popover
                                ref="popover"
                                placement="bottom"
                                width="290"
                                v-model="arrShow[i].isShow"
                                trigger="click">
                                <div class="slot-txt">
                                    <p>删除后不会影响已群发的图文消息，确定删除该素材吗？</p>
                                    <p>
                                        <el-button class="btn-green" @click="deleteNews(i)">确定</el-button>
                                        <el-button @click="cancelPopover(i)">取消</el-button>
                                    </p>
                                </div>
                                <i class="trash icon ion-ios-trash" slot="reference"></i>
                            </el-popover>
                        </el-tooltip>                        
                    </template>
                </div>
            </div>
            <div v-if="lists.length <= 0">暂无数据</div>
            <div class="clearfix"></div>
        </div>
        <div class="div-list-view" v-else>
            <table>
                <thead>
                    <tr>
                        <td style="min-width: 120px;"></td>
                        <td style="width:70%; min-width: 300px;"></td>
                        <td style="width:10%; min-width: 200px;"></td>
                        <td style="width:10%; min-width: 200px;"></td>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(item, i) in lists">
                        <td><a class="img" :style="{backgroundImage: 'url('+ item.cover +')'}"></a></td>
                        <td class="tit">
                            <a class="title">{{item.title}}</a>
                            <span class="type">{{item.type == 1 ? '图文素材' : '图文链接'}}</span>
                        </td>
                        <td>{{item.updated_at | date}}</td>
                        <td class="opr">
                            <a @click="toUrl('/wechat/material/edit',{id: item.id})">编辑</a>
                            <el-popover
                                ref="popover"
                                placement="bottom"
                                width="290"
                                v-model="arrShow[i].isShow"
                                trigger="click">
                                <div class="slot-txt">
                                    <p>删除后不会影响已群发的图文消息，确定删除该素材吗？</p>
                                    <p>
                                        <el-button class="btn-green" @click="deleteNews(i)">确定</el-button>
                                        <el-button @click="cancelPopover(i)">取消</el-button>
                                    </p>
                                </div>
                                <a slot="reference">删除</a>
                            </el-popover>
                        </td>
                    </tr>
                    <tr v-if="lists.length <= 0">
                        <td>暂无数据</td>
                    </tr>
                </tbody>
            </table>
        </div>        
        <div class="page-wrap text-right pr25">
            <base-page
                :page="page"
                :lists="lists"
                :isCloseOneAutoGetData="false"
                :isMonitorHistoryState="false"
                v-on:getPageList="getPageList"
            ></base-page>
        </div>
    </div>

</template>
<script>
    import {basePage} from 'hanzi-vue-package';
    tools.vue.use(basePage);
    import {Input,Button,Dropdown,DropdownMenu,DropdownItem,Popover,Tooltip,DatePicker} from 'element-ui';
    tools.vue.use(Input);
    tools.vue.use(Button);
    tools.vue.use(Dropdown);
    tools.vue.use(DropdownMenu);
    tools.vue.use(DropdownItem);
    tools.vue.use(Popover);
    tools.vue.use(Tooltip);
    tools.vue.use(DatePicker);
    
    export default{
        data(){
            return {
                inputTxt: '',
                timerange: [],
                is_grid: 1,
                lists : [
                ],
                page : {},
                isShow: false,
                arrShow: [],
            }
        },
        computed:{

        },
        methods: {
            search: function(){
                let that = this;
                that.getList(1);
            },
            getList: function(page, page_size){
                let that = this, ajaxData = {};
                ajaxData.page = page;
                if(that.inputTxt != ''){
                    ajaxData.title = that.inputTxt;
                }
                if(that.timerange[0]){
                    ajaxData.begin_time = parseInt(that.timerange[0]/1000);
                    ajaxData.end_time = parseInt(that.timerange[1]/1000);
                }

                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/newses',
                    ajaxData: ajaxData,
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        if(res && res.list){
                            that.page = res.list;
                            for(let i in res.list.data){
                                res.list.data[i].isShow = false;
                                that.arrShow.push({isShow: false});
                            }
                            that.lists = res.list.data;
                            //that.lists = Object.assign({}, that.lists);
                        }
                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'GET'
                });
            },
            deleteNews: function(i){
                let that = this;

                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/newses/' + that.lists[i].id,
                    ajaxData: {},
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        that.lists.splice(i, 1);
                        that.arrShow.splice(i, 1);

                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'DELETE'
                });

            },
            /* 分页数据 */
            getPageList: function (page, page_size) {
                var that = this;
                that.getList(page, page_size)
            },
            cancelPopover: function(idx){
                let that = this;
                that.arrShow[idx].isShow = false;
            },
            /* 跳转 */
            toUrl: function (url, val) {
                tools.router.push({path: url, query: val});
            }

        },
        components: {
        },
        filters:{
            date: function (timestamp, format){
                //let f = 'Y-m-d H:i';
                let f = 'Y年m月d日';
                if(format){
                    f = format;
                }
                return tools.date(f, timestamp);
            },
        },
        watch:{
            isShow: function(v){
                console.log(v);
            }

        },
        mounted(){

        }
    }
</script>
<style rel="stylesheet/scss" lang="scss">
    @import "../../../assets/tool";
    @import "../../../assets/sass/common/wechat_btn";
    [i="app-msg"]{
        min-width: 900px;
        .div-search{
            .el-input{
                width: 300px;
            }
        }
        .div-opt{
            height: 100%;
            overflow: auto;
            line-height: 34px;
            .btn-create{
                border: none;
                background-color: #44b549;
                color: #fff;
                &:hover{
                    background-color: #2f9833;
                }
            }
            .btn-create-share{
                background-color: #44b549;
                vertical-align: top;
                cursor: pointer;
                @include rounded(4px);
                &:hover{
                    background-color: #2f9833;
                    @include rounded(4px);
                }
                .classify-title{
                        height: 34px;
                        width: 34px;
                        text-align: center;
                        display: block;
                    i{
                        color: #fff;
                        margin: 0 !important;
                        line-height: 34px;
                    }
                }

            }
            .i-rank{
                font-size: 24px;
                cursor: pointer;
                color: rgb(171, 172, 174);
                &.grid-rank{
                }
                &.active{
                    color: #000;
                }
            }            
        }
        .div-grid-view{
            &>div.grid-item{
                width: 300px;
                height: 350px;
                border: 1px solid #e7e7eb;
                float: left;
                margin: 5px;
                .time{
                    height: 45px;
                    line-height: 45px;                    
                    margin: 0 20px;
                    border-bottom: 1px solid #e7e7eb;
                    position: relative;
                    .type{
                        background-color: #009688;
                        height: 18px;
                        line-height: 18px;
                        margin-top: 12px;
                        padding: 0 3px 0 5px;
                        color: #fff;
                        font-size: 12px;
                        &:after{
                            content: '';
                            border: 10px solid #009688;
                            position: absolute;
                            border-top: transparent;
                            border-right: transparent;
                            border-bottom: transparent;
                            border-width: 9px;
                            border-style: solid;
                            right: -18px;
                        }
                    }
                }
                .body{
                    position: relative;
                    height: 248px;
                        cursor: pointer;
                    .content{
                        position: absolute;
                        width: 100%;
                        height: 100%;
                        padding: 10px;
                        span{
                            max-width: 100%;
                            display: inline-block;
                            height: 20px;
                        }
                        .bg{
                            width: 100%;
                            height: 188px;
                            background: no-repeat center center/cover;
                        }
                    }
                    .hover{
                        position: absolute;
                        display: none;
                        height: 248px;
                        width: 100%;
                        line-height: 248px;
                        text-align: center;
                        color: #fff;
                    }
                    &:hover .hover{
                        display: block;
                        background-color: rgba(0, 0, 0, .5);
                    }
                }
                .opr{
                    border-top: 1px solid #e7e7eb;
                    display: flex;
                    height: 55px;
                    line-height: 55px;
                    &>i{
                        border-right: 1px solid #e7e7eb;
                    }
                    i{
                        text-align: center;
                        background-color: rgb(244, 244, 244);
                        cursor: pointer;
                        color: rgb(178, 178, 178);
                        flex-grow: 1;
                        align-items: stretch;
                        font-size: 24px;
                        &.create{}
                        &.trash{}
                        &:hover{
                            color: #000;
                        }
                    }

                    &>span{
                        text-align: center;
                        background-color: rgb(244, 244, 244);
                        cursor: pointer;
                        color: rgb(178, 178, 178);
                        flex-grow: 1;
                        align-items: stretch;
                        font-size: 24px;                        
                        border-right: 1px solid #e7e7eb;
                        &.create{}
                        &.trash{}
                        &:last-child{
                            border-right: none;
                        }
                        &:hover{
                            color: #000;
                        }
                    }
                }
            }
        }
        .div-list-view{
            border-top: 1px solid #e7e7eb;
            table{
                width: 100%;
                tbody{
                    tr{
                        border-bottom: 1px solid #e7e7eb;
                        td{
                            padding: 15px 0;
                            vertical-align: top;
                            .img{
                                width: 100px;
                                height: 100px;
                                display: block;
                                background-size: cover;
                            }
                            .title{
                                color: #333;
                            }
                            &.opr{
                                a{
                                    margin: 0 10px;
                                }
                            }

                        }
                        .tit{                            
                            position: relative;
                            .type{
                                background-color: #009688;
                                height: 18px;
                                line-height: 18px;
                                margin-top: 12px;
                                padding: 0 3px 0 5px;
                                color: #fff;
                                font-size: 12px;
                                position: absolute;
                                bottom: 15px;
                                left: 0;
                                &:after{
                                    content: '';
                                    border: 10px solid #009688;
                                    position: absolute;
                                    border-top: transparent;
                                    border-right: transparent;
                                    border-bottom: transparent;
                                    border-width: 9px;
                                    border-style: solid;
                                    left: 56px;
                                    bottom: 0;
                                }
                            }
                        }
                    }

                }
            }

        }

    }
</style>
