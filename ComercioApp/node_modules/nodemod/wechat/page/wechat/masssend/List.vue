<template>
    <div i="wechat-mass-list">
        <!-- <div class="div-search">
            <el-input
              placeholder="标题"
              v-model.trim="inputTxt">
            </el-input>    
            <el-date-picker
                v-model="timerange"
                type="daterange"
                placeholder="选择日期范围">
            </el-date-picker> 
            <el-button class="btn-green" @click="search">搜索</el-button>  
        </div> -->

        <el-button class="btn-green" @click="toUrl('./send')">新建群发</el-button>
        <div class="mass-list" v-if="lists.length > 0">
            <div class="mass-item" v-for="(item, i) in lists">
                <div class="pull-left item-left">
                    <span>{{item.created_at | date}}</span>
                    <a v-if="item.mass_result == 0">未发送</a>
                    <a v-else-if="item.mass_result == 1">发送成功</a>
                    <a v-else-if="item.mass_result == 2">发送失败</a>
                </div>
                <div class="pull-left item-right">
                    <div class="item-header">
                        <a class="pull-right" @click="deleteMass(i)">删除</a>                    
                        <div class="appmsg" v-if="item.type == 1">
                            <a v-for="news in item.news" v-if="item.news" @click="toUrl('/wechat/material/preview',{id: item.id})" class="am" :style="{backgroundImage: 'url('+ news.cover +')'}" :title="news.title">
                                <span>{{news.title}}</span>
                            </a>
                        </div>
                        <a class="title" v-else-if="item.type == 2" :title="item.text">{{item.text}}</a>
                        <a class="pic" v-else-if="item.type == 3" :style="{backgroundImage: 'url('+ item.media.path +')'}"></a>                    
                        <div class="clearfix"></div>
                    </div>
                    <div class="item-type">
                        <a v-if="item.type == 1">图文消息</a>
                        <a v-else-if="item.type == 2">文字消息</a>
                        <a v-else-if="item.type == 3">图片消息</a>
                    </div>
                    <div class="item-body">
                        <div class="item-block">
                            <span class="title">阅读数</span>
                            <span class="num">0</span>
                        </div>
                        <div class="item-block">
                            <span class="title">点赞</span>
                            <span class="num">0</span>
                        </div>
                    </div>
                    
                </div>
                <div class="clearfix"></div>
            </div>
        </div>
        <div v-else class="mt50">
            暂无内容
        </div>
        <div class="page-wrap text-right pr25">
            <base-page
                :page="page"
                :lists="lists"
                :isCloseOneAutoGetData="false"
                :isMonitorHistoryState="false"
                v-on:getPageList="getPageList"
            ></base-page>
        </div>
    </div>
</template>
<style rel="stylesheet/scss" lang="scss">
    @import "../../../assets/tool";    
    @import "../../../assets/sass/common/wechat_btn";
    [i="wechat-mass-list"]{
        width: 950px;
        .div-search{
            .el-input{
                width: 300px;
            }
        }
        .mass-list{
            .item-left{
                width: 125px;
            }
            .item-right{
                width: 825px;
            }
            .mass-item{
                margin-top: 40px;
                width: 100%;
                min-height: 175px;
                .item-header{
                    .appmsg{
                        max-width: 760px;
                        height: 76px;
                        .am{
                            float: left;
                            margin-right: 10px;
                            width: 76px;
                            height: 76px;
                            display: inline-block;
                            position: relative;
                            background-size: cover;
                            background-repeat: no-repeat;
                            span{
                                width: 100%;
                                padding-left: 5px;
                                display: inline-block;
                                max-width: 76px;
                                @include wordEllipsis();
                                position: absolute;
                                bottom: 0;
                                background-color:rgba(0,0,0,.5);
                                color: #fff;
                            }
                        }
                    }
                    .pic{    
                        display: block;
                        width: 76px;
                        height: 76px;
                        background-size: cover;
                        background-repeat: no-repeat;
                    }
                    .title{    
                        font-size: 16px;
                        color: #222;
                        max-width: 530px;
                        @include wordEllipsis();    
                        margin-right: 5px;
                        display: inline-block;
                        vertical-align: text-bottom;
                    }
                }
                .item-type{
                    margin-top: 8px;
                    a{
                        color: #8d8d8d;
                        display: inline-block;
                        vertical-align: middle;
                        margin-right: 1em;
                        line-height: 1.3;
                        background-color: #f6f8f9;
                        padding: 0 .3em;
                    }
                }
                .item-body{
                    background-color: #f6f8f9;
                    margin-top: 20px;
                    padding: 20px 0 0;
                    margin-bottom: -10px;
                    min-height: 78px;
                    .item-block{
                        display: inline-block;
                        vertical-align: top;
                        text-align: center;
                        min-width: 16%;
                        margin-bottom: 20px;
                        margin-right: 20px;

                        .title{
                            color: #8d8d8d;
                            display: block;
                        }
                        .num{
                            display: block;
                            font-size: 26px;
                            line-height: 1;
                            padding-top: 10px;

                        }
                    }
                }
            }
        }

    }
</style>
<script>
    import {basePage} from 'hanzi-vue-package';
    tools.vue.use(basePage);
    import {Input,Button,DatePicker} from 'element-ui';
    tools.vue.use(Input);
    tools.vue.use(Button);
    tools.vue.use(DatePicker);
    
    export default{
        data(){
            this.crumbs.push({name:'微信管理'},{name:'群发列表'});
            return {
                inputTxt: '',
                timerange: [],
                lists : [
                ],
                page : {},
            }
        },
        props: ['crumbs'],
        computed:{

        },
        methods: {
            search: function(){
                let that = this;
                that.getList(1);
            },
            getList: function(page, page_size){
                let that = this, ajaxData = {};
                ajaxData.page = page;
                if(that.inputTxt != ''){
                    ajaxData.title = that.inputTxt;
                }
                if(that.timerange[0]){
                    ajaxData.begin_time = parseInt(that.timerange[0]/1000);
                    ajaxData.end_time = parseInt(that.timerange[1]/1000);
                }

                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/mass',
                    ajaxData: ajaxData,
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        if(res && res.list){
                            that.page = res.list;
                            that.lists = res.list.data;
                        }
                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'GET'
                });
            },
            /* 分页数据 */
            getPageList: function (page, page_size) {
                var that = this;
                that.getList(page, page_size)
            },
            deleteMass: function(i){
                let that = this, id = that.lists[i].id;

                if(id <= 0){
                    return false;
                }

                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/mass/'+ id,
                    ajaxData: {},
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        if(res && res.status){
                            tools.alert.message('删除成功');
                            that.lists.splice(i, 1);
                        }
                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'DELETE'
                });

            },
            /* 跳转 */
            toUrl: function (url, val) {
                tools.router.push({path: url, query: val});
            }

        },
        components: {
        },
        filters:{
            date: function (timestamp, format){
                let f = 'Y-m-d H:i';
                //let f = 'Y年m月d日';
                if(format){
                    f = format;
                }
                return tools.date(f, timestamp);
            },

        },
        watch:{

        },
        mounted(){

        }
    }
</script>
