<template>
    <div i="wechat-mass-send">        
        <div class="send-msg">
            <ul>
                <li :class="{active: msg_type === 1}" @click="msg_type = 1"><i class="menu-con appmsg"></i>图文</li>
                <li :class="{active: msg_type === 2}" @click="msg_type = 2"><i class="icon ion-android-create"></i>文字</li>
                <li :class="{active: msg_type === 3}" @click="msg_type = 3"><i class="menu-con img"></i>图片</li>
                <!-- <li :class="{active: msg_type === 3}" @click="msg_type = 3"><i class="menu-con voice"></i>语音</li>
                <li :class="{active: msg_type === 4}" @click="msg_type = 4"><i class="menu-con video"></i>视频</li> -->
            </ul>
            <div class="msg-con" v-show="msg_type === 2">
                <div class="div-edit" id="msgeditor" contenteditable="true" @blur="divBlur" tabindex="1"></div>
                <div class="div-emotion">
                    <button class="emoj" style="display: none;"></button>
                    <span class="pull-right" :class="{danger: msgTxt.length > 64}" style="display: none;">{{msgTxt.length}}/600</span>
                </div>
            </div>
            <div class="msg-con" v-show="msg_type === 1">
                <div v-show="news_ids.length > 0" 
                    v-for="(news, i) in news_ids"
                    class="news-item" :style="{backgroundImage: 'url('+ news.cover +')'}">
                    <span>{{news.title}}</span>
                    <div class="cover-del" @click="deleteNews(i)"><i class="icon ion-ios-trash"></i></div>
                </div>
                <a class="add-material" @click="showMaterialDlg = true" v-show="news_ids.length < 8">
                    <i class="icon ion-ios-plus-empty"></i>
                    从素材库中选择
                </a>
            </div>
            <div class="msg-con" v-show="msg_type === 3">
                <div v-show="media_path != ''" 
                    class="news-item" :style="{backgroundImage: 'url('+ media_path +')'}">
                    <div class="cover-del" @click="deleteMedia"><i class="icon ion-ios-trash"></i></div>
                </div>
                <a class="add-material" v-show="media_path == ''" @click="showPhotoDlg = true">
                    <i class="icon ion-ios-plus-empty"></i>
                    从素材库中选择
                </a>
                <!-- <a class="add-material">
                    <i class="icon ion-ios-plus-empty"></i>
                    上传图片
                </a> -->
            </div>
        </div>
        <div class="mt20">
            <el-button class="btn-green" @click="save">群发</el-button>
        </div>
        <material-select-dialog
            @closeDlg="closeMaterialDlg"
            :title="'选择图文'"
            :dialogVisible="showMaterialDlg">                
        </material-select-dialog>

        <photo-select-dialog 
            @closeDlg="closePhotoDlg"
            :title="'选择图片'"
            :dialogVisible="showPhotoDlg">
            </photo-select-dialog>
    </div>
</template>
<style rel="stylesheet/scss" lang="scss">
    @import "../../../assets/tool";    
    @import "../../../assets/sass/common/wechat_btn";
    [i="wechat-mass-send"]{        
        .send-msg{
            width: 927px;
            border: 1px solid #e7e7eb;
            background-color: #fff;
            ul{
                border-bottom: 1px solid #e7e7eb;
                height: 100%;
                overflow: auto;
                padding-left: 30px;
                li{
                    height: 39px;
                    line-height: 39px;
                    float: left;
                    position: relative;
                    cursor: pointer;
                    color: #8d8d8d;
                    margin-right: 40px;
                    i.icon{
                        font-size: 20px;
                        vertical-align: middle;
                        color: #8d8d8d;
                        padding-right: 5px;
                    }
                    i.menu-con{
                        vertical-align: top;
                        background-image: url(../../../assets/msg_tab.png);
                        display: inline-block;
                        margin-right: 3px;
                        &.appmsg{
                            width: 20px;
                            height: 30px;
                            background-position-y: 179px;
                        }
                        &.img{
                            width: 20px;
                            height: 30px;
                            background-position-y: 359px;
                        }
                        &.voice{
                            width: 20px;
                            height: 30px;
                            background-position-y: 238px;
                        }
                        &.video{
                            width: 20px;
                            height: 30px;
                            background-position-y: 299px;
                        }
                    }
                    &.active{
                        color: #222;
                        .appmsg{
                            background-position-y: 149px!important;
                        }
                        .img{
                            width: 20px;
                            height: 30px;
                            background-position-y: 329px!important;
                        }
                        .voice{
                            width: 20px;
                            height: 30px;
                            background-position-y: 208px!important;
                        }
                        .video{
                            width: 20px;
                            height: 30px;
                            background-position-y: 269px!important;
                        }
                        i.icon{
                            color: #222;
                        }

                    }
                    &:hover i{
                        &.appmsg{
                            background-position-y: 149px;
                        }
                        &.img{
                            width: 20px;
                            height: 30px;
                            background-position-y: 329px;
                        }
                        &.voice{
                            width: 20px;
                            height: 30px;
                            background-position-y: 208px;
                        }
                        &.video{
                            width: 20px;
                            height: 30px;
                            background-position-y: 269px;
                        }
                    }
                }
            }
            .msg-con{
                width: 100%;
                min-height: 213px;
                max-height: 325px;
                overflow-y: auto;
                position: relative;                

                .news-item{
                    width: 217px;    
                    height: 145px;
                    background-repeat: no-repeat;
                    background-position: center center;
                    background-size: cover;
                    position: relative;
                    margin-left: 20px;
                    margin-top: 10px;
                    background-color: #ececec;
                    span{
                        width: 100%;
                        height: 28px;
                        line-height: 28px;
                        color: #fff;
                        position: absolute;
                        bottom: 0;
                        padding: 0 10px;
                        display: inline-block;
                        @include wordEllipsis();
                        background-color: rgba(0,0,0,.5);
                    }
                    .cover-del{
                        width: 100%;
                        height: 100%;
                        position: absolute;
                        display: none;  
                        line-height: 145px;
                        text-align: center;
                        color: #fff;
                        font-size: 64px;
                        cursor: pointer;
                    }
                    &:hover .cover-del{
                        display: block;
                        background-color: rgba(0, 0, 0, .5);
                    }
                }
                .div-edit{
                    /* position: absolute;
                    top: 0; */
                    width: 100%;
                    /* min-height: 176px; */
                    height: 176px;
                    overflow-y: auto;
                    outline: 0;
                    padding: 20px;
                }
                .div-emotion{
                    position: absolute;
                    bottom: 0;
                    width: 100%;
                    height: 37px;
                    border-top: 1px solid #e7e7eb;
                    padding: 0 20px;
                    .emoj{
                        background: url(../../../assets/emotion_editor.png) no-repeat 0 0;
                        width: 20px;
                        height: 20px;
                        margin-top: 8px;
                        &:hover{
                            background-position-y: -24px;
                        }
                    }
                    span{
                        line-height: 37px;
                    }
                }
                .add-material{
                    color: #8d8d8d;
                    width: 217px;
                    height: 145px;
                    border: 2px dotted #e7e7eb;
                    display: inline-block;
                    font-size: 14px;
                    text-align: center;
                    margin: 20px 0 0 20px;
                    i{
                        font-size: 64px;
                        display: block;
                    }
                    &:first-child{
                        margin-right: 30px;
                    }

                }
            }
        }
    }
</style>
<script>
    import materialSelectDialog from '../../../components/wechat/Materialselectdialog';
    import photoSelectDialog from '../../../components/wechat/Photoselectdialog.vue';
    import {Button} from 'element-ui';
    tools.vue.use(Button);
    
    export default{
        data(){
            this.crumbs.push({name:'微信管理'},{name:'群发管理',url:'/wechat/masssend/list'},{name:'添加群发'});
            return {
                msg_type: 1,
                msgTxt: '',
                media_path: '',
                media_id: 0,
                news_ids:[],
                showMaterialDlg: false,
                showPhotoDlg: false,
            }
        },
        props: ['crumbs'],
        computed:{

        },
        methods: {
            getData: function(){
                let that = this;

                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/responses/2',
                    ajaxData: {},
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        if(res && res.status){
                            /*that.msg_type = res.data.rsp_type;
                            that.msgTxt = res.data.text ? res.data.text : '';
                            that.media_id = res.data.wechat_media_id;
                            if(res.data.news && res.data.news.length > 0){
                                that.news_ids = res.data.news;
                            }
                            if(that.msgTxt != ''){
                                $('#msgeditor').html(that.msgTxt);
                            }*/

                            for(let i in res.data){
                                switch(res.data[i].rsp_type){
                                    case 1:{
                                        that.msgTxt = res.data[i].text;
                                        if(that.msgTxt != ''){
                                            $('#msgeditor').html(that.msgTxt);
                                        }
                                    };break;
                                    case 2:{
                                        that.news_ids = res.data[i].news;
                                        /*for(let j in res.data[i].news){
                                        }*/
                                    };break;
                                    case 3:{
                                        that.media_path = res.data[i].img_url;
                                        that.media_id = res.data[i].wechat_media_id;
                                    };break;
                                }
                            }
                            if(that.media_path){
                                that.rsp_type = 3;
                            }
                            if(that.news_ids.length > 0){
                                that.rsp_type = 2;
                            }
                            if(that.msgTxt != ''){
                                that.rsp_type = 1;
                            }
                        }
                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'GET'
                });

            },
            divBlur: function(){
                let that = this;
                that.msgTxt = $('#msgeditor').html();
            },
            closeMaterialDlg: function(obj){
                let that = this;
                that.showMaterialDlg = false;
                if(obj){
                    that.news_ids.push({
                        news_id: obj.img_arr[0].id,
                        cover: obj.img_arr[0].cover
                    });
                }
            },
            deleteNews: function(idx){
                let that = this;
                that.news_ids.splice(idx ,1);
            },
            closePhotoDlg: function(obj){
                let that = this;
                that.showPhotoDlg = false;
                if(obj){
                    that.media_id = obj.img_arr[0].id;
                    that.media_path = obj.img_arr[0].path;
                }                
            },
            deleteMedia: function(){
                let that = this;
                that.media_path = '';
                that.media_id = 0;
            },
            save: function(){
                let that = this, ajaxData = {};
                /*ajaxData.data = [];

                ajaxData.data.push({
                    rsp_type: 1,
                    text: that.msgTxt
                });
                if(that.media_id > 0){
                    ajaxData.data.push({
                        rsp_type: 3,
                        wechat_media_id: that.media_id
                    });                    
                }

                let tmpNews = [];
                for(let i in that.news_ids){
                    tmpNews.push(that.news_ids[i].news_id);
                }
                ajaxData.data.push({
                    rsp_type: 2,
                    news: tmpNews
                });*/

                ajaxData.mass_obj = 0;
                ajaxData.type = that.msg_type;
                switch(that.msg_type){
                    case 1:{
                        let tmpNews = [];
                        for(let i in that.news_ids){
                            tmpNews.push(that.news_ids[i].news_id);
                        }
                        ajaxData.wechat_new_id = tmpNews;
                    };break;
                    case 2:{
                        ajaxData.text = that.msgTxt;
                    };break;
                    case 3:{
                        ajaxData.wechat_media_id = that.media_id;
                    };break;

                }
                console.log(ajaxData);
                
                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/mass',
                    ajaxData: ajaxData,
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        tools.alert.message('发送成功');
                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'POST'
                });


            },
            deleteResponse: function(){
                let that = this;

                tools.alert.loading();
                tools.ajax({
                    url: '/api/admin/wechat/responses/2',
                    ajaxData: {},
                    successFun: function (res) {
                        tools.alert.closeLoading();
                        tools.alert.message('删除成功');
                        that.msgTxt = '';
                        $('#msgeditor').empty();
                        that.media_path = '';
                        that.media_id = 0;
                        that.news_ids = [];
                    },
                    errorFun: function (error_data, status, headers, error_obj) {
                        tools.alert.closeLoading();
                        tools.alert.error(error_data.error_msg);
                    },
                    type: 'DELETE'
                });
            }

        },
        components: {
            materialSelectDialog,
            photoSelectDialog
        },
        filters:{

        },
        watch:{

        },
        mounted(){
            this.getData();

        }
    }
</script>
